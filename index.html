<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBI Executive Dashboard</title>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-card: #3a3a3a;
            --text-primary: #ffffff;
            --text-secondary: #a3a3a3;
            --accent-grey: #6b7280;
            --accent-orange: #d97706;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --border-color: #4a4a4a;
            --progress-bg: #2a2a2a;
        }

        body.light-mode {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #6c757d;
            --accent-grey: #4b5563;
            --accent-orange: #ea580c;
            --accent-green: #198754;
            --accent-red: #dc3545;
            --border-color: #dee2e6;
            --progress-bg: #e9ecef;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: var(--bg-primary);
            padding: 20px;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
            scroll-behavior: smooth;
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 4px,
                rgba(255, 255, 255, 0.03) 4px,
                rgba(255, 255, 255, 0.03) 5px
            );
        }

        body.light-mode {
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 4px,
                rgba(0, 0, 0, 0.03) 4px,
                rgba(0, 0, 0, 0.03) 5px
            );
        }

        html {
            scroll-behavior: smooth;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
        }

        .header-left h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--accent-grey), var(--accent-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .last-updated {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 400;
            margin-bottom: 8px;
        }

        .summary-text {
            font-size: 14px;
            font-style: italic;
            color: var(--text-secondary);
            line-height: 1.5;
            max-width: 800px;
        }

        .theme-toggle {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle:hover {
            background: var(--bg-secondary);
            transform: translateY(-1px);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 12px;
        }

        /* Tasks */
        .task {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
            background: var(--bg-secondary);
            transition: all 0.2s ease;
        }

        .task:hover {
            background: var(--bg-primary);
        }

        .task:last-child {
            border-bottom: 1px solid var(--border-color);
        }

        .task input[type="checkbox"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-orange);
        }

        .task label {
            flex: 1;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
        }

        .task-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .task-text {
            font-size: 14px;
            color: var(--text-primary);
        }

        .task-owner {
            font-size: 12px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .task input[type="checkbox"]:checked + .task-details .task-text {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .task-input {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .task-input input {
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .task-input input.notes-input {
            grid-column: 1 / -1;
        }

        .task-input button {
            grid-column: 1 / -1;
        }

        .task-total {
            background: var(--accent-grey);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
        }

        .task-input input:focus {
            outline: none;
            border-color: var(--accent-orange);
            background: var(--bg-primary);
        }

        .task-input button,
        button {
            padding: 10px 20px;
            background: var(--accent-grey);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .task-input button:hover,
        button:hover {
            background: var(--accent-orange);
            transform: translateY(-1px);
        }

        /* Progress Bars */
        .progress-section {
            margin-bottom: 20px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .launch-btn {
            padding: 8px 16px;
            background: var(--accent-green);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .launch-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .progress-item {
            margin-bottom: 20px;
        }

        .progress-item:last-child {
            margin-bottom: 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .progress-bar {
            width: 100%;
            height: 28px;
            background: var(--progress-bg);
            border-radius: 14px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-orange));
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 12px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Hierarchy */
        .hierarchy {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.8;
        }

        .hierarchy-item {
            padding: 8px 0;
            position: relative;
        }

        .hierarchy-item input {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            font-family: inherit;
            font-size: inherit;
            width: 100%;
            padding: 6px 10px;
            color: var(--text-primary);
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .hierarchy-item input:focus {
            outline: none;
            border-color: var(--accent-orange);
            background: var(--bg-primary);
            box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.1);
        }

        .indent-1 { padding-left: 20px; }
        .indent-2 { padding-left: 40px; }
        .indent-3 { padding-left: 60px; }

        /* Links */
        .links-list {
            list-style: none;
        }

        .link-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .link-item:hover {
            background: var(--bg-primary);
        }

        .link-item:last-child {
            border-bottom: 1px solid var(--border-color);
        }

        .link-item a {
            color: var(--accent-orange);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            flex: 1;
        }

        .link-item a:hover {
            color: var(--accent-grey);
        }

        .link-actions {
            display: flex;
            gap: 4px;
        }

        button.edit-btn {
            background: var(--accent-grey);
            color: white;
            font-size: 13px;
            padding: 6px 14px;
            border-radius: 8px;
            font-weight: 500;
        }

        button.edit-btn:hover {
            background: var(--accent-orange);
            transform: translateY(-1px);
        }

        button.details-btn {
            background: var(--accent-orange);
            color: white;
            font-size: 13px;
            padding: 6px 14px;
            border-radius: 8px;
            font-weight: 500;
            margin-left: 8px;
        }

        button.details-btn:hover {
            background: #b45309;
            transform: translateY(-1px);
        }

        .link-item small {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .add-link {
            margin-top: 10px;
        }

        .add-link input {
            display: block;
            width: 100%;
            padding: 10px 14px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .add-link input:focus {
            outline: none;
            border-color: var(--accent-orange);
            background: var(--bg-primary);
        }

        /* Meeting Summaries */
        .meeting {
            margin-bottom: 20px;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .meeting:hover {
            background: var(--bg-primary);
        }

        .meeting:last-child {
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 0;
        }

        .meeting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .meeting-title {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
        }

        .meeting-date {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .meeting-summary {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .add-meeting {
            margin-top: 15px;
        }

        .add-meeting input,
        .add-meeting textarea {
            display: block;
            width: 100%;
            padding: 10px 14px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .add-meeting input:focus,
        .add-meeting textarea:focus {
            outline: none;
            border-color: var(--accent-orange);
            background: var(--bg-primary);
        }

        .add-meeting textarea {
            resize: vertical;
            min-height: 90px;
        }

        button.delete-btn {
            background: var(--accent-red);
            color: white;
            font-size: 13px;
            padding: 6px 14px;
            margin-left: 8px;
            border-radius: 8px;
            font-weight: 500;
        }

        button.delete-btn:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }

        /* Password & Data Management */
        .auth-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: 15px;
        }

        .lock-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .lock-indicator.unlocked {
            color: var(--accent-green);
            border-color: var(--accent-green);
        }

        .lock-indicator.locked {
            color: var(--accent-red);
            border-color: var(--accent-red);
        }

        button.secondary-btn {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            font-size: 13px;
        }

        button.secondary-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-orange);
        }

        .header-separator {
            width: 1px;
            height: 32px;
            background: var(--border-color);
            margin: 0 15px;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            border: 1px solid var(--border-color);
        }

        .modal h3 {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-size: 20px;
        }

        .modal-content-text {
            margin-bottom: 15px;
        }

        .modal-content-text label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .modal-content-text p {
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .modal-content-text p.empty {
            color: var(--text-secondary);
            font-style: italic;
        }

        .modal input {
            width: 100%;
            padding: 10px 14px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .modal input:focus {
            outline: none;
            border-color: var(--accent-orange);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 10px 20px;
        }

        .editing-disabled {
            pointer-events: none;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>TBI Executive Dashboard</h1>
                <div class="last-updated" id="lastUpdated">Last updated: Loading...</div>
                <div class="summary-text" contenteditable="false" id="summaryText">
                    This dashboard provides a comprehensive overview of organizational tasks, progress metrics, team structure, and key resources. Edit this summary to customize your dashboard description.
                </div>
            </div>
            <div style="display: flex; align-items: center;">
                <div class="auth-controls">
                    <div class="lock-indicator locked" id="lockIndicator">
                        <span id="lockIcon">ðŸ”’</span>
                        <span id="lockText">Locked</span>
                    </div>
                    <button class="secondary-btn" onclick="toggleLock()">
                        <span id="lockButtonText">Unlock</span>
                    </button>
                    <button class="secondary-btn" onclick="exportData()">Export</button>
                    <button class="secondary-btn" onclick="importData()">Import</button>
                </div>
                <div class="header-separator"></div>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">ðŸŒ™</span>
                    <span id="themeText">Dark Mode</span>
                </button>
            </div>
        </div>

        <!-- Progress Bar Section (full width) -->
        <div class="card progress-section">
            <div class="progress-header">
                <div class="progress-title">Progress to Launch</div>
                <button class="launch-btn" onclick="handleLaunch()">ðŸš€ Launched</button>
            </div>
            <div class="progress-item">
                <div class="progress-label">
                    <span>Overall Completion</span>
                    <span id="overall-percent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="overall-progress" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Tasks Section -->
            <div class="card">
                <h2>Active Tasks</h2>
                <div id="tasksList"></div>
                <div class="task-total" id="activeTaskTotal">Total Active Tasks: 0</div>
                <div class="task-input">
                    <input type="text" id="newTask" placeholder="Task description...">
                    <input type="text" id="taskOwner" placeholder="Owner (optional)...">
                    <input type="text" id="taskNotes" class="notes-input" placeholder="(Max 250 characters) Enter task details..." maxlength="250">
                    <button onclick="addTask()">Add Task</button>
                </div>
            </div>

            <!-- Task Archive Section -->
            <div class="card">
                <h2>Task Archive</h2>
                <div id="archiveList"></div>
                <div class="task-total" id="archiveTaskTotal">Total Archived Tasks: 0</div>
            </div>
        </div>

        <div class="grid">
            <!-- Hierarchy Section -->
            <div class="card">
                <h2>Organizational Structure</h2>
                <div class="hierarchy" id="hierarchy">
                    <div class="hierarchy-item">
                        <input type="text" value="ðŸ‘” Chief Executive Officer" onchange="saveHierarchy()">
                    </div>
                    <div class="hierarchy-item indent-1">
                        <input type="text" value="â”œâ”€â”€ ðŸ’¼ Chief Operating Officer" onchange="saveHierarchy()">
                    </div>
                    <div class="hierarchy-item indent-2">
                        <input type="text" value="â”‚   â”œâ”€â”€ ðŸ‘¥ HR Director" onchange="saveHierarchy()">
                    </div>
                    <div class="hierarchy-item indent-2">
                        <input type="text" value="â”‚   â””â”€â”€ ðŸ“Š Operations Manager" onchange="saveHierarchy()">
                    </div>
                    <div class="hierarchy-item indent-1">
                        <input type="text" value="â”œâ”€â”€ ðŸ’° Chief Financial Officer" onchange="saveHierarchy()">
                    </div>
                    <div class="hierarchy-item indent-2">
                        <input type="text" value="â”‚   â”œâ”€â”€ ðŸ“ˆ Finance Manager" onchange="saveHierarchy()">
                    </div>
                    <div class="hierarchy-item indent-2">
                        <input type="text" value="â”‚   â””â”€â”€ ðŸ§¾ Accounting Team Lead" onchange="saveHierarchy()">
                    </div>
                    <div class="hierarchy-item indent-1">
                        <input type="text" value="â””â”€â”€ ðŸŽ¯ Chief Technology Officer" onchange="saveHierarchy()">
                    </div>
                    <div class="hierarchy-item indent-2">
                        <input type="text" value="    â”œâ”€â”€ ðŸ’» Development Manager" onchange="saveHierarchy()">
                    </div>
                    <div class="hierarchy-item indent-2">
                        <input type="text" value="    â””â”€â”€ ðŸ”§ IT Support Lead" onchange="saveHierarchy()">
                    </div>
                </div>
            </div>

            <!-- Links Section -->
            <div class="card">
                <h2>Quick Links</h2>
                <ul class="links-list" id="linksList"></ul>
                <div class="add-link">
                    <input type="text" id="linkTitle" placeholder="Link title...">
                    <input type="text" id="linkUrl" placeholder="URL...">
                    <button onclick="addLink()" style="width: 100%;">Add Link</button>
                </div>
            </div>
        </div>

        <!-- Meeting Summaries Section -->
        <div class="card">
            <h2>Meeting Summaries</h2>
            <div id="meetingsList"></div>
            <div class="add-meeting">
                <input type="text" id="meetingTitle" placeholder="Meeting title...">
                <input type="date" id="meetingDate">
                <textarea id="meetingSummary" placeholder="Meeting summary..."></textarea>
                <button onclick="addMeeting()" style="width: 100%;">Add Meeting</button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="modal-overlay" id="passwordModal">
        <div class="modal">
            <h3 id="modalTitle">Set Password</h3>
            <input type="password" id="passwordInput" placeholder="Enter password">
            <div class="modal-buttons">
                <button class="secondary-btn" onclick="closePasswordModal()">Cancel</button>
                <button onclick="submitPassword()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Task Details Modal -->
    <div class="modal-overlay" id="taskDetailsModal">
        <div class="modal">
            <h3 id="taskDetailsTitle">Task Details</h3>
            <div class="modal-content-text">
                <label>Task</label>
                <p id="taskDetailsText"></p>
            </div>
            <div class="modal-content-text">
                <label>Owner</label>
                <p id="taskDetailsOwner" class="empty">No owner assigned</p>
            </div>
            <div class="modal-content-text">
                <label>Details</label>
                <p id="taskDetailsNotes" class="empty">No task details</p>
            </div>
            <div class="modal-buttons">
                <button onclick="closeTaskDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        // TODO: Replace these with your actual Supabase credentials
        // Get them from: Supabase Dashboard > Project Settings > API
        const SUPABASE_URL = 'YOUR_SUPABASE_URL_HERE';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE';

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Check if Supabase is configured
        const isSupabaseConfigured = SUPABASE_URL !== 'YOUR_SUPABASE_URL_HERE' && 
                                     SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY_HERE';

        // ============================================
        // DATA MANAGEMENT
        // ============================================
        // Local data (used as fallback if Supabase not configured)
        let tasks = [];
        let links = [];
        let meetings = [];
        let hierarchyData = [];
        let settingsData = {};

        // ============================================
        // SUPABASE HELPER FUNCTIONS
        // ============================================
        
        // Tasks
        async function loadTasksFromSupabase() {
            const { data, error } = await supabase
                .from('tasks')
                .select('*')
                .order('created_at', { ascending: true });
            
            if (error) {
                console.error('Error loading tasks:', error);
                return [];
            }
            return data || [];
        }

        async function addTaskToSupabase(task) {
            const { data, error} = await supabase
                .from('tasks')
                .insert([task])
                .select();
            
            if (error) console.error('Error adding task:', error);
            return data?.[0];
        }

        async function updateTaskInSupabase(id, updates) {
            const { error } = await supabase
                .from('tasks')
                .update({ ...updates, updated_at: new Date().toISOString() })
                .eq('id', id);
            
            if (error) console.error('Error updating task:', error);
        }

        async function deleteTaskFromSupabase(id) {
            const { error } = await supabase
                .from('tasks')
                .delete()
                .eq('id', id);
            
            if (error) console.error('Error deleting task:', error);
        }

        // Links
        async function loadLinksFromSupabase() {
            const { data, error } = await supabase
                .from('links')
                .select('*')
                .order('created_at', { ascending: true });
            
            if (error) {
                console.error('Error loading links:', error);
                return [];
            }
            return data || [];
        }

        async function addLinkToSupabase(link) {
            const { data, error } = await supabase
                .from('links')
                .insert([link])
                .select();
            
            if (error) console.error('Error adding link:', error);
            return data?.[0];
        }

        async function updateLinkInSupabase(id, updates) {
            const { error } = await supabase
                .from('links')
                .update(updates)
                .eq('id', id);
            
            if (error) console.error('Error updating link:', error);
        }

        async function deleteLinkFromSupabase(id) {
            const { error } = await supabase
                .from('links')
                .delete()
                .eq('id', id);
            
            if (error) console.error('Error deleting link:', error);
        }

        // Meetings
        async function loadMeetingsFromSupabase() {
            const { data, error } = await supabase
                .from('meetings')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('Error loading meetings:', error);
                return [];
            }
            return data || [];
        }

        async function addMeetingToSupabase(meeting) {
            const { data, error } = await supabase
                .from('meetings')
                .insert([meeting])
                .select();
            
            if (error) console.error('Error adding meeting:', error);
            return data?.[0];
        }

        async function deleteMeetingFromSupabase(id) {
            const { error } = await supabase
                .from('meetings')
                .delete()
                .eq('id', id);
            
            if (error) console.error('Error deleting meeting:', error);
        }

        // Hierarchy
        async function loadHierarchyFromSupabase() {
            const { data, error } = await supabase
                .from('hierarchy')
                .select('*')
                .order('position', { ascending: true });
            
            if (error) {
                console.error('Error loading hierarchy:', error);
                return [];
            }
            return data || [];
        }

        async function saveHierarchyToSupabase(hierarchyArray) {
            // Delete all existing hierarchy
            await supabase.from('hierarchy').delete().neq('id', '00000000-0000-0000-0000-000000000000');
            
            // Insert new hierarchy
            const hierarchyToInsert = hierarchyArray.map((value, index) => ({
                position: index,
                value: value
            }));
            
            const { error } = await supabase
                .from('hierarchy')
                .insert(hierarchyToInsert);
            
            if (error) console.error('Error saving hierarchy:', error);
        }

        // Settings
        async function loadSettingFromSupabase(key) {
            const { data, error } = await supabase
                .from('settings')
                .select('value')
                .eq('key', key)
                .single();
            
            if (error && error.code !== 'PGRST116') { // PGRST116 = not found
                console.error('Error loading setting:', error);
            }
            return data?.value;
        }

        async function saveSettingToSupabase(key, value) {
            const { error } = await supabase
                .from('settings')
                .upsert({ 
                    key: key, 
                    value: value,
                    updated_at: new Date().toISOString()
                }, { 
                    onConflict: 'key' 
                });
            
            if (error) console.error('Error saving setting:', error);
        }

        // ============================================
        // REAL-TIME SUBSCRIPTIONS
        // ============================================
        
        function setupRealtimeSubscriptions() {
            if (!isSupabaseConfigured) return;

            // Subscribe to tasks changes
            supabase
                .channel('tasks-channel')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, async () => {
                    tasks = await loadTasksFromSupabase();
                    renderTasks();
                })
                .subscribe();

            // Subscribe to links changes
            supabase
                .channel('links-channel')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'links' }, async () => {
                    links = await loadLinksFromSupabase();
                    renderLinks();
                })
                .subscribe();

            // Subscribe to meetings changes
            supabase
                .channel('meetings-channel')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'meetings' }, async () => {
                    meetings = await loadMeetingsFromSupabase();
                    renderMeetings();
                })
                .subscribe();

            // Subscribe to hierarchy changes
            supabase
                .channel('hierarchy-channel')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'hierarchy' }, async () => {
                    hierarchyData = await loadHierarchyFromSupabase();
                    loadHierarchy();
                })
                .subscribe();

            // Subscribe to settings changes
            supabase
                .channel('settings-channel')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'settings' }, async () => {
                    await loadAllSettings();
                })
                .subscribe();
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        async function initializeDashboard() {
            if (isSupabaseConfigured) {
                console.log('âœ… Supabase configured - loading data from database');
                
                // Load all data from Supabase
                tasks = await loadTasksFromSupabase();
                links = await loadLinksFromSupabase();
                meetings = await loadMeetingsFromSupabase();
                hierarchyData = await loadHierarchyFromSupabase();
                
                // Load settings
                await loadAllSettings();
                
                // Setup real-time subscriptions
                setupRealtimeSubscriptions();
            } else {
                console.warn('âš ï¸ Supabase not configured - using localStorage fallback');
                
                // Load from localStorage (old behavior)
                tasks = JSON.parse(localStorage.getItem('tasks')) || [
                    { id: '1', text: 'Review Q1 performance reports', owner: 'Sarah Chen', notes: 'Focus on revenue growth and customer acquisition metrics', completed: true },
                    { id: '2', text: 'Schedule executive team meeting', owner: 'Michael Torres', notes: 'Discuss strategic planning for Q2', completed: false },
                    { id: '3', text: 'Approve budget allocations', owner: '', notes: '', completed: false }
                ];
                links = JSON.parse(localStorage.getItem('links')) || [
                    { id: '1', title: 'Company Portal', url: 'https://portal.company.com' },
                    { id: '2', title: 'HR Management System', url: 'https://hr.company.com' },
                    { id: '3', title: 'Financial Dashboard', url: 'https://finance.company.com' }
                ];
                meetings = JSON.parse(localStorage.getItem('meetings')) || [
                    { id: '1', title: 'Executive Board Meeting', date: '2024-01-15', summary: 'Reviewed company performance metrics, discussed strategic initiatives for Q2, and approved new hiring plan for engineering department.' },
                    { id: '2', title: 'Leadership Strategy Session', date: '2024-01-22', summary: 'Outlined 3-year growth strategy, identified key market opportunities, and assigned action items to department heads.' }
                ];
            }
            
            // Render all sections
            loadTheme();
            loadLastUpdated();
            loadSummaryText();
            renderTasks();
            renderLinks();
            renderMeetings();
            loadHierarchy();
            lockDashboard();
        }

        async function loadAllSettings() {
            const theme = await loadSettingFromSupabase('theme');
            if (theme) {
                localStorage.setItem('theme', theme);
                loadTheme();
            }
            
            const summaryText = await loadSettingFromSupabase('summaryText');
            if (summaryText) {
                localStorage.setItem('summaryText', summaryText);
                loadSummaryText();
            }
            
            const lastUpdated = await loadSettingFromSupabase('lastUpdated');
            if (lastUpdated) {
                localStorage.setItem('lastUpdated', lastUpdated);
                loadLastUpdated();
            }
        }

        // Password & Lock Management
        let isUnlocked = false;
        let storedPassword = localStorage.getItem('dashboardPassword');
        let isSettingPassword = false;

        function toggleLock() {
            if (!storedPassword) {
                // First time - set password
                isSettingPassword = true;
                document.getElementById('modalTitle').textContent = 'Set Password';
                document.getElementById('passwordInput').placeholder = 'Create a password';
                document.getElementById('passwordModal').classList.add('active');
            } else if (isUnlocked) {
                // Lock the dashboard
                lockDashboard();
            } else {
                // Unlock the dashboard
                isSettingPassword = false;
                document.getElementById('modalTitle').textContent = 'Enter Password';
                document.getElementById('passwordInput').placeholder = 'Enter password';
                document.getElementById('passwordModal').classList.add('active');
            }
        }

        function submitPassword() {
            const input = document.getElementById('passwordInput');
            const password = input.value;

            if (!password) {
                alert('Please enter a password');
                return;
            }

            if (isSettingPassword) {
                // Setting new password
                storedPassword = password;
                localStorage.setItem('dashboardPassword', password);
                unlockDashboard();
                alert('Password set successfully!');
            } else {
                // Verifying password
                if (password === storedPassword) {
                    unlockDashboard();
                } else {
                    alert('Incorrect password');
                    return;
                }
            }

            closePasswordModal();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('active');
            document.getElementById('passwordInput').value = '';
        }

        function unlockDashboard() {
            isUnlocked = true;
            document.getElementById('lockIndicator').classList.remove('locked');
            document.getElementById('lockIndicator').classList.add('unlocked');
            document.getElementById('lockIcon').textContent = 'ðŸ”“';
            document.getElementById('lockText').textContent = 'Unlocked';
            document.getElementById('lockButtonText').textContent = 'Lock';
            document.getElementById('summaryText').contentEditable = 'true';
            
            // Enable all editing
            document.querySelectorAll('.task-input, .add-link, .add-meeting, .hierarchy').forEach(el => {
                el.classList.remove('editing-disabled');
            });
        }

        function lockDashboard() {
            isUnlocked = false;
            document.getElementById('lockIndicator').classList.remove('unlocked');
            document.getElementById('lockIndicator').classList.add('locked');
            document.getElementById('lockIcon').textContent = 'ðŸ”’';
            document.getElementById('lockText').textContent = 'Locked';
            document.getElementById('lockButtonText').textContent = 'Unlock';
            document.getElementById('summaryText').contentEditable = 'false';
            
            // Disable all editing
            document.querySelectorAll('.task-input, .add-link, .add-meeting, .hierarchy').forEach(el => {
                el.classList.add('editing-disabled');
            });
        }

        // Export Data
        function exportData() {
            const data = {
                password: storedPassword,
                tasks: tasks,
                links: links,
                meetings: meetings,
                hierarchy: Array.from(document.querySelectorAll('#hierarchy input')).map(input => input.value),
                summaryText: document.getElementById('summaryText').textContent,
                theme: localStorage.getItem('theme'),
                lastUpdated: localStorage.getItem('lastUpdated'),
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `tbi-dashboard-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Import Data
        function importData() {
            if (confirm('Importing will replace all current data. Continue?')) {
                document.getElementById('fileInput').click();
            }
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Restore data
                    if (data.password) localStorage.setItem('dashboardPassword', data.password);
                    if (data.tasks) {
                        tasks = data.tasks;
                        localStorage.setItem('tasks', JSON.stringify(tasks));
                    }
                    if (data.links) {
                        links = data.links;
                        localStorage.setItem('links', JSON.stringify(links));
                    }
                    if (data.meetings) {
                        meetings = data.meetings;
                        localStorage.setItem('meetings', JSON.stringify(meetings));
                    }
                    if (data.hierarchy) {
                        localStorage.setItem('hierarchy', JSON.stringify(data.hierarchy));
                    }
                    if (data.summaryText) {
                        localStorage.setItem('summaryText', data.summaryText);
                    }
                    if (data.theme) {
                        localStorage.setItem('theme', data.theme);
                    }
                    if (data.lastUpdated) {
                        localStorage.setItem('lastUpdated', data.lastUpdated);
                    }

                    alert('Data imported successfully! Reloading dashboard...');
                    location.reload();
                } catch (error) {
                    alert('Error importing file. Please ensure it\'s a valid backup file.');
                }
            };
            reader.readAsText(file);
        }

        // Theme Management
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            body.classList.toggle('light-mode');
            
            const newTheme = body.classList.contains('light-mode') ? 'light' : 'dark';
            
            if (body.classList.contains('light-mode')) {
                themeIcon.textContent = 'â˜€ï¸';
                themeText.textContent = 'Light Mode';
            } else {
                themeIcon.textContent = 'ðŸŒ™';
                themeText.textContent = 'Dark Mode';
            }
            
            localStorage.setItem('theme', newTheme);
            if (isSupabaseConfigured) {
                saveSettingToSupabase('theme', newTheme);
            }
            updateLastUpdated();
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('themeIcon').textContent = 'â˜€ï¸';
                document.getElementById('themeText').textContent = 'Light Mode';
            }
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const now = new Date();
            const formatted = now.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            document.getElementById('lastUpdated').textContent = `Last updated: ${formatted}`;
            const isoString = now.toISOString();
            localStorage.setItem('lastUpdated', isoString);
            if (isSupabaseConfigured) {
                saveSettingToSupabase('lastUpdated', isoString);
            }
        }

        // Load last updated time
        function loadLastUpdated() {
            const saved = localStorage.getItem('lastUpdated');
            if (saved) {
                const date = new Date(saved);
                const formatted = date.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
                document.getElementById('lastUpdated').textContent = `Last updated: ${formatted}`;
            } else {
                updateLastUpdated();
            }
        }

        // Tasks
        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            const activeTasks = tasks.filter(t => !t.completed);
            
            if (activeTasks.length === 0) {
                tasksList.innerHTML = '<div style="color: var(--text-secondary); padding: 20px; text-align: center;">No active tasks</div>';
            } else {
                tasksList.innerHTML = activeTasks.map((task, index) => {
                    const originalIndex = tasks.indexOf(task);
                    return `
                        <div class="task">
                            <input type="checkbox" id="task-${originalIndex}" ${task.completed ? 'checked' : ''} onchange="toggleTask(${originalIndex})">
                            <div class="task-details">
                                <div class="task-text">${task.text}</div>
                                ${task.owner ? `<div class="task-owner">Owner: ${task.owner}</div>` : ''}
                            </div>
                            <button class="details-btn" onclick="showTaskDetails(${originalIndex})">Details</button>
                            <button class="delete-btn" onclick="deleteTask(${originalIndex})">Delete</button>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('activeTaskTotal').textContent = `Total Active Tasks: ${activeTasks.length}`;
            
            renderArchive();
            updateProgress();
        }

        function renderArchive() {
            const archiveList = document.getElementById('archiveList');
            const completedTasks = tasks.filter(t => t.completed);
            
            if (completedTasks.length === 0) {
                archiveList.innerHTML = '<div style="color: var(--text-secondary); padding: 20px; text-align: center;">No completed tasks</div>';
            } else {
                archiveList.innerHTML = completedTasks.map((task, index) => {
                    const originalIndex = tasks.indexOf(task);
                    return `
                        <div class="task">
                            <input type="checkbox" id="archive-${originalIndex}" checked onchange="toggleTask(${originalIndex})">
                            <div class="task-details">
                                <div class="task-text">${task.text}</div>
                                ${task.owner ? `<div class="task-owner">Owner: ${task.owner}</div>` : ''}
                            </div>
                            <button class="details-btn" onclick="showTaskDetails(${originalIndex})">Details</button>
                            <button class="delete-btn" onclick="deleteTask(${originalIndex})">Delete</button>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('archiveTaskTotal').textContent = `Total Archived Tasks: ${completedTasks.length}`;
        }

        function showTaskDetails(index) {
            const task = tasks[index];
            
            document.getElementById('taskDetailsText').textContent = task.text;
            
            const ownerElement = document.getElementById('taskDetailsOwner');
            if (task.owner && task.owner.trim()) {
                ownerElement.textContent = task.owner;
                ownerElement.classList.remove('empty');
            } else {
                ownerElement.textContent = 'No owner assigned';
                ownerElement.classList.add('empty');
            }
            
            const notesElement = document.getElementById('taskDetailsNotes');
            if (task.notes && task.notes.trim()) {
                notesElement.textContent = task.notes;
                notesElement.classList.remove('empty');
            } else {
                notesElement.textContent = 'No task details';
                notesElement.classList.add('empty');
            }
            
            document.getElementById('taskDetailsModal').classList.add('active');
        }

        function closeTaskDetailsModal() {
            document.getElementById('taskDetailsModal').classList.remove('active');
        }

        function handleLaunch() {
            const confirmed = confirm('Mark project as launched? This will update the dashboard status.');
            if (confirmed) {
                alert('ðŸŽ‰ Project Launched Successfully!');
                updateLastUpdated();
            }
        }

        async function addTask() {
            if (!isUnlocked) {
                alert('Please unlock the dashboard to edit');
                return;
            }
            const taskInput = document.getElementById('newTask');
            const ownerInput = document.getElementById('taskOwner');
            const notesInput = document.getElementById('taskNotes');
            
            if (taskInput.value.trim()) {
                const newTask = { 
                    text: taskInput.value.trim(), 
                    owner: ownerInput.value.trim(),
                    notes: notesInput.value.trim(),
                    completed: false 
                };
                
                if (isSupabaseConfigured) {
                    await addTaskToSupabase(newTask);
                    tasks = await loadTasksFromSupabase();
                } else {
                    newTask.id = Date.now().toString();
                    tasks.push(newTask);
                    saveTasks();
                }
                
                taskInput.value = '';
                ownerInput.value = '';
                notesInput.value = '';
                renderTasks();
                updateLastUpdated();
            }
        }

        async function toggleTask(index) {
            if (!isUnlocked) {
                alert('Please unlock the dashboard to edit');
                renderTasks(); // Re-render to reset checkbox
                return;
            }
            
            const task = tasks[index];
            const newCompletedState = !task.completed;
            
            if (isSupabaseConfigured) {
                await updateTaskInSupabase(task.id, { completed: newCompletedState });
                tasks = await loadTasksFromSupabase();
            } else {
                task.completed = newCompletedState;
                saveTasks();
            }
            
            renderTasks();
            updateLastUpdated();
        }

        async function deleteTask(index) {
            if (!isUnlocked) {
                alert('Please unlock the dashboard to edit');
                return;
            }
            
            const task = tasks[index];
            
            if (isSupabaseConfigured) {
                await deleteTaskFromSupabase(task.id);
                tasks = await loadTasksFromSupabase();
            } else {
                tasks.splice(index, 1);
                saveTasks();
            }
            
            renderTasks();
            updateLastUpdated();
        }

        function saveTasks() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }

        // Progress
        function updateProgress() {
            if (tasks.length === 0) return;
            const completed = tasks.filter(t => t.completed).length;
            const percentage = Math.round((completed / tasks.length) * 100);
            const progressBar = document.getElementById('overall-progress');
            const percentText = document.getElementById('overall-percent');
            
            progressBar.style.width = percentage + '%';
            percentText.textContent = percentage + '%';
        }

        // Hierarchy
        async function saveHierarchy() {
            if (!isUnlocked) {
                alert('Please unlock the dashboard to edit');
                loadHierarchy(); // Reset to saved state
                return;
            }
            const inputs = document.querySelectorAll('#hierarchy input');
            const hierarchy = Array.from(inputs).map(input => input.value);
            
            if (isSupabaseConfigured) {
                await saveHierarchyToSupabase(hierarchy);
            } else {
                localStorage.setItem('hierarchy', JSON.stringify(hierarchy));
            }
            
            updateLastUpdated();
        }

        function loadHierarchy() {
            const inputs = document.querySelectorAll('#hierarchy input');
            
            if (isSupabaseConfigured && hierarchyData.length > 0) {
                inputs.forEach((input, index) => {
                    if (hierarchyData[index]) {
                        input.value = hierarchyData[index].value;
                    }
                });
            } else {
                const saved = JSON.parse(localStorage.getItem('hierarchy'));
                if (saved) {
                    inputs.forEach((input, index) => {
                        if (saved[index]) input.value = saved[index];
                    });
                }
            }
        }

        // Links
        function renderLinks() {
            const linksList = document.getElementById('linksList');
            linksList.innerHTML = links.map((link, index) => `
                <li class="link-item">
                    <a href="${link.url}" target="_blank">${link.title}</a>
                    <div class="link-actions">
                        <button class="edit-btn" onclick="editLink(${index})">Edit</button>
                        <button class="delete-btn" onclick="deleteLink(${index})">Delete</button>
                    </div>
                </li>
            `).join('');
        }

        async function editLink(index) {
            if (!isUnlocked) {
                alert('Please unlock the dashboard to edit');
                return;
            }
            const link = links[index];
            const newTitle = prompt('Edit link title:', link.title);
            const newUrl = prompt('Edit link URL:', link.url);
            
            if (newTitle !== null && newTitle.trim() && newUrl !== null && newUrl.trim()) {
                if (isSupabaseConfigured) {
                    await updateLinkInSupabase(link.id, { title: newTitle.trim(), url: newUrl.trim() });
                    links = await loadLinksFromSupabase();
                } else {
                    links[index] = { ...link, title: newTitle.trim(), url: newUrl.trim() };
                    saveLinks();
                }
                renderLinks();
                updateLastUpdated();
            }
        }

        async function addLink() {
            if (!isUnlocked) {
                alert('Please unlock the dashboard to edit');
                return;
            }
            const title = document.getElementById('linkTitle');
            const url = document.getElementById('linkUrl');
            
            if (title.value.trim() && url.value.trim()) {
                const newLink = { title: title.value.trim(), url: url.value.trim() };
                
                if (isSupabaseConfigured) {
                    await addLinkToSupabase(newLink);
                    links = await loadLinksFromSupabase();
                } else {
                    newLink.id = Date.now().toString();
                    links.push(newLink);
                    saveLinks();
                }
                
                title.value = '';
                url.value = '';
                renderLinks();
                updateLastUpdated();
            }
        }

        async function deleteLink(index) {
            if (!isUnlocked) {
                alert('Please unlock the dashboard to edit');
                return;
            }
            
            const link = links[index];
            
            if (isSupabaseConfigured) {
                await deleteLinkFromSupabase(link.id);
                links = await loadLinksFromSupabase();
            } else {
                links.splice(index, 1);
                saveLinks();
            }
            
            renderLinks();
            updateLastUpdated();
        }

        function saveLinks() {
            localStorage.setItem('links', JSON.stringify(links));
        }

        // Meetings
        function renderMeetings() {
            const meetingsList = document.getElementById('meetingsList');
            meetingsList.innerHTML = meetings.map((meeting, index) => `
                <div class="meeting">
                    <div class="meeting-header">
                        <div class="meeting-title">${meeting.title}</div>
                        <div class="meeting-date">${meeting.date}</div>
                    </div>
                    <div class="meeting-summary">${meeting.summary}</div>
                    <button class="delete-btn" onclick="deleteMeeting(${index})">Delete</button>
                </div>
            `).join('');
        }

        async function addMeeting() {
            if (!isUnlocked) {
                alert('Please unlock the dashboard to edit');
                return;
            }
            const title = document.getElementById('meetingTitle');
            const date = document.getElementById('meetingDate');
            const summary = document.getElementById('meetingSummary');
            
            if (title.value.trim() && date.value && summary.value.trim()) {
                const newMeeting = { 
                    title: title.value.trim(), 
                    date: date.value, 
                    summary: summary.value.trim() 
                };
                
                if (isSupabaseConfigured) {
                    await addMeetingToSupabase(newMeeting);
                    meetings = await loadMeetingsFromSupabase();
                } else {
                    newMeeting.id = Date.now().toString();
                    meetings.unshift(newMeeting);
                    saveMeetings();
                }
                
                title.value = '';
                date.value = '';
                summary.value = '';
                renderMeetings();
                updateLastUpdated();
            }
        }

        async function deleteMeeting(index) {
            if (!isUnlocked) {
                alert('Please unlock the dashboard to edit');
                return;
            }
            
            const meeting = meetings[index];
            
            if (isSupabaseConfigured) {
                await deleteMeetingFromSupabase(meeting.id);
                meetings = await loadMeetingsFromSupabase();
            } else {
                meetings.splice(index, 1);
                saveMeetings();
            }
            
            renderMeetings();
            updateLastUpdated();
        }

        function saveMeetings() {
            localStorage.setItem('meetings', JSON.stringify(meetings));
        }

        // Summary text editing
        document.getElementById('summaryText').addEventListener('blur', function() {
            if (!isUnlocked) {
                loadSummaryText(); // Reset to saved state
                return;
            }
            const text = this.textContent;
            localStorage.setItem('summaryText', text);
            if (isSupabaseConfigured) {
                saveSettingToSupabase('summaryText', text);
            }
            updateLastUpdated();
        });

        function loadSummaryText() {
            const saved = localStorage.getItem('summaryText');
            if (saved) {
                document.getElementById('summaryText').textContent = saved;
            }
        }

        // Enter key handlers
        document.getElementById('newTask').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addTask();
        });

        document.getElementById('linkUrl').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addLink();
        });

        // Close modal on background click
        document.getElementById('passwordModal').addEventListener('click', function(e) {
            if (e.target === this) closePasswordModal();
        });

        document.getElementById('taskDetailsModal').addEventListener('click', function(e) {
            if (e.target === this) closeTaskDetailsModal();
        });

        // Enter key in password modal
        document.getElementById('passwordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitPassword();
        });

        // Initialize dashboard
        initializeDashboard();
    </script>
</body>
</html>
